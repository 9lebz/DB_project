# Аптека "За углом"

Вы делаете информационную систему для большой аптечной сети. 

### Лекарства

У каждого лекарства есть торговое название, международное непатентованное название, лекарственная форма (это таблетка, капсула, ампула или что-то еще) и производитель. Например, у лекарства с торговым названием <<Фуфломицин>> и лекарственной формой <<порошок>>, производителем является Тьмутараканский завод лекарственных препаратов, а международным названием -- _placebo_. Ещё у лекарства есть основное действующее средство -- это некоторое химическое соединение, у которого есть название (например, _aqua pura_), химическая формула (например $H_2O$) и текстовое описание. Разумеется, у разных лекарств вполне могут быть одинаковые основные действующие средства.

Кроме этого, у каждого лекарства есть сертификат. У сертификата есть номер, срок действия и указание на исследовательскую лабораторию, проводившую испытания. Таких лабораторий несколько, и вам интересно от каждой лишь её название и актуальная на данный момент фамилия руководителя.

### Оптовое хранение
Лекарства вашим аптекам поставляют дистрибьюторы -- это некие юридические лица с адресом, номером банковского счета (почитайте о том, как выглядят международные банковские номера) фамилией и именем контактного лица и его телефоном.

От дистрибьюторов вы получаете поставки. Поставка -- это некоторое количество (небольших) контейнеров с лекарствами. В каждом контейнере находятся розничные упаковки одного и того же лекарства. В разных контейнерах могут быть, конечно, разные лекарства. В каждой поставке все контейнеры с одним и тем же лекарством одинаковые, в каждом одно и то же количество розничных упаковок. 

Для каждой поставки вам известен её состав: сколько контейнеров того или иного лекарства в этой поставке, сколько в каждом контейнере розничных упаковок и какая закупочная стоимость одной розничной упаковки лекарства в этой поставке.

Каждая поставка производится на какой-то из нескольких складов. У склада есть номер и адрес, и когда поставка приезжает на этот склад, вы записываете время прибытия и фамилию кладовщика, принявшего поставку.

**UPD 2021-10-18**

### Розничная продажа
У вас есть некоторое количество розничных аптек. У каждой аптеки имеется адрес и номер, известный покупателям (например, <<Аптека за углом №7>> по адресу 7-я линия, дом 18). Каждая аптека продаёт некоторое подмножество лекарств, по своей цене за розничную упаковку. Вы записываете эту цену и количество имеющихся в аптеке в данный момент розничных упаковок лекарства.

**UPD 2021-10-25**

Время от времени вам нужно пополнять запасы лекарств в аптеках. С этой целью вы обращаетесь в службу перевозки, с просьбой дать вам несколько газелей с водителями. Каждому водителю даётся задание на день вида "такого то числа взять с такого то склада столько то контейнеров такого-то лекарства для такой то аптеки, столько-то контейнеров другого лекарства для сякой-то, и т.д.". Контейнеры с одинаковым лекарством по-прежнему одинаковые, соответствие задания фактическому наличию запасов на складах вас не волнует. 

Вы записываете номер газели, фио водителя и реквизиты компаний-перевозчиков: адреса и телефоны. Это нужно, чтобы если вдруг возникнет проблема с какой-то газелью или водителем, знать, куда звонить его начальству.

**Дополнение №3 от 2021-11-01**
### Приложение "Моя аптека"

Вы хотите дать вашим конечным пользователям, покупающим у вас лекарства, возможность хранить историю приобретения лекарств и их хранения дома. Какие-то пользователи хотят записывать врача и причину, по которой лекарство назначено, и даты курса лечения, чтобы, найдя дома таблетки с названием "Таррокан", понять, нужны ли они ещё. Другие методично распихивают дома лекарства по пронумерованным ящичкам и хотят, чтобы можно было найти, в каких ящичках лежат лекарства с истекающим сроком годности, не перерывая всё. В целом, возможные хотелки пользователей в отношении купленной упаковки лекарства разнообразны и плохо предсказуемы, но можно попробовать свести их к множеству пар ключ-значение, где текстовому ключу сопоставляется текстовое, темпоральное, целочисленное или булевское значения, например "срок"="2021-12-01" "назначил"="А.И.Болит", "помогает"=false

Эти значения пользователи могут определять для сделанных у вас покупок, то есть для розничной упаковки лекарства с каким-то патентованным названием, купленным в такую-то дату. Аутентификация 
 пользователей происходит при помощи стороннего сервиса, где хранится и вся их персональная информация. Вам от сервиса приходят email пользователя и его ник, который он выбрал для вашего приложения.

**Дополнение №4 от 2021-11-01**
### Прокат медицинского оборудования

Вы хотите сделать возможность брать напрокат медицинское оборудование, например тонометры, костыли, аппараты ИВЛ, etc. У вас есть каталог оборудования, где для каждого сдаваемого в аренду экземпляра указан его тип, модель, актуальная стоимость аренды за сутки. Каждый экземпляр может быть доставлен, по запросу, в одну из нескольких аптек, и их список у вас записан, чтобы можно было показывать его клиенту. Ваши клиенты выбирают тип и модель оборудования, смотрят, какие экземпляры есть в наличии и где их можно взять, после чего выбирают аптеку, где будут забирать оборудование, и на следующий день приходят туда. С клиентом подписывается договор аренды, в котором записывается ФИО и номер паспорта, срок начала и окончания аренды, полная стоимость и указание, в какой аптеке клиент вернёт оборудование.

## App
**Дополнение №5 от 2021-11-15**

### Основные свойства лекарства

Необходимо реализовать API метод, возвращающий JSON с основными свойствами лекарства.

**Путь**:  `/drug/info` 
**Аргументы** `name: text` -- обязательное название лекарства, либо патентованное, либо международное 
**Пример запроса** `/drug/info?name=placebo`
**Структура ответа**
Если лекарство найдено по международному названию, в ответе должны быть все имеющиеся в базе лекарства с таким названием. Если лекарство найдено по патентованному названию, в ответе должно быть оно одно, если оно есть в базе.
```
[
{
  "id": "123456",
  "trade_name": "фуфломицин", // патентованное название
  "international_name": "placebo", // международное непатентованное название
  "active_ingredient": "aqua pura", // Активный ингредиент
  "is_available": true // Наличие в аптеках, по сведениям об остатках лекарства в аптеках
},
{
  "id": "6872463",
  "trade_name": "флуципирин",
  "international_name": "placebo", 
  "active_ingredient": "aqua pura", 
  "is_available": false 
},
]
```

**Дополнение №6 от 2021-11-15**

### Поиск лекарства по аптекам
Необходимо реализовать API метод, возвращающий JSON с информацией о наличии и ценах на лекарство в аптеках

**Путь**:  `/drug/search` 
**Аргументы** `id: text|number` -- обязательный идентификатор лекарства, `user: text` -- опциональный идентификатор пользователя
**Пример запроса** `/drug/search?id=123456&user=elon@mu.sk`
**Структура ответа**
В ответе должны быть минимальная и максимальная цены на лекарство по всем аптекам. Кроме этого, должен быть список аптек, в которых лекарство есть, с указанием имеющегося количества и цены, а если его нет, но имеется заказ на доставку со склада, то должно быть обозначено, что ожидается поступление. 

Если указан идентификатор ползователя, то ответ нужно дополнить имеющейся в базе информацией пользователя о данном лекарстве.

```
{
  "id": "123456",
  "trade_name": "фуфломицин".
  "min_price": 25.0,
  "max_price": 78.0,
  "stores": [
    {
      "num": 6,
      "address": "7-я линия В.О., 16",
      "available": 8,
      "price": 32.0
    },
    {
      "num": 3,
      "address": "Дворцовая пл, 2",
      "available": 0,
      "expected": true,
      "price": 78.0
    }
  ],
  "user_data": [
    {
      "key": "помогает",
      "value": "да"
    },
    {
      "key": "назначил",
      "value": "А.И.Болит"
    }
  ]
}
```

**Дополнение №7 от 2021-11-22**
### Информация о продажах лекарства

Необходимо реализовать API метод, возвращающий JSON с информацией о суммах продаж лекарств в аптеках

**Путь**:  `/drug/sales` 
**Аргументы** 
`id: text|number`: -- идентификатор лекарства, опциональный
**Примеры запросов** `/drug/sales`,  `/drug/sales?id=1234`
**Структура ответа**
Если указан конкретный идентификатор, то ожидается только информация об указанном лекарстве. Если идентификатор не указан, возвращается информация обо всех лекарствах, имеющихся в базе

```
[
  {
    "id": "1234",
    "title": "фуфломицин"
    "sum_sales": 1234567890,
  },
  {
    "id": "4321",
    "title": "кудапропал",
    "sum_sales": 100500,
  }
]
```

Приложение должно брать информацию о продажах из представления, не проводя никаких действий, кроме перекладывания данных из одной структуры в другую.

В первоначальной версии сумма продаж высчитывается приблизительно, исходя из информации о поставках лекарства со складов в аптеки. Мы считаем, что каждая поставка полностью продаётся, соответственно, сумма доходов от продаж лекарства в каждой аптеке -- это суммарное количество поставленного туда лекарства, умноженное на цену розничной упаковки в этой аптеки, а сумма общая -- это сумма по всем аптекам.

Далее схему БД и вычисление суммы продаж нужно будет поменять. Мы решили таки записывать каждый день в каждой аптеке информаци о том, сколько какого лекарства было продано и по какой цене, на случай если цена будет меняться. Соответственно, доход от продаж будет теперь считаться как сумма по новым таблицам. 

Представление нужно изменить так, чтобы код приложения оставался работоспособным без изменений.

Код представления, изменения схемы БД и изменённого представления нужно записать в файл `src/main/sql/task7.sql`


**Дополнение №9 от 2021-11-30**
### Перераспределение лекарств

Если в некоторых наших аптеках эконом-класса есть большие запасы некого лекарства, например фуфломицина, по низкой цене, а в аптеках премиум класса, продающих то же самое лекарство по высокой цене, оно заканчивается, то мы хотим перераспределить остатки. Этот метод рассматривает остатки указанного лекарства по аптекам в порядке возрастания цены лекарства в аптеке. Если в аптеке излишек остатков лекарства, то есть разница между имеющимся остатком и указанным минимально допустимым, неотрицателен, то мы перераспределяем излишек в аптеку с наивысшей ценой продажи и отрицательным излишком. Делаем так до тех пор, пока не перераспределим всё или пока не достигнем желаемого целевого увеличения прибыли, исходя из предположения, что мы продадим всё что есть в аптеках.

**Путь**: `/drug/shuffle`
**Аргументы**
`drug_id: text|number` идентификатор перераспределяемого лекарства
`min_remainder: number`:  минимально допустимый остаток лекарства
`target_income_increase: number`: целевое увеличение прибыли: на сколько больше талеров мы хотим заработать

Все аргументы обязательные.

**Структура ответа**
Возвращает JSON указанного ниже вида, где каждый элемент массива обозначает перемещение лекарства:

```
[
  {
    "from_pharmacy_id": 1, // откуда перемещаем
    "to_pharmacy_id": 10, // куда перемещаем
    "price_difference": 200, // разница в цене
    "count": 20 // количество перемещаемых отпускных упаковок
  },
  ...
]
```

**Дополнение №10 от 2021-12-01**
### Редактирование свойств лекарства

Необходимо реализовать API метод для редактирования свойств лекарства

**Путь**:  `/drug/edit` 
**Аргументы** 
`id: text/number` -- идентификатор лекарства, обязательный
`edit_session: text` -- опциональный индентификатор сеанса редактирования (см. ниже)
`commit: boolean` --указание закончить сеанс редактирования и подтвердить изменения, опциональный
`trade_name: text` -- опциональное патентованное название лекарства
`active_ingredient: text` -- опциональное название действующего вещества

**Примеры запросов** 
`/drug/edit?id=3&name=фуфломицинпро&commit=true` -- меняет название лекарства 3 на "фуфломицинпро" и немедленно подтверждает действие.
`/drug/edit?id=3` -- начинает сеанс редактирования лекарства 3
`/drug/edit?id=3&edit_session=146&active_ingredient=сахар` -- в сеансе редактирования 146 лекарства 3 меняет действующее вещество на сахар, сеанс редактирования не заканчивается
`/drug/edit?id=3&edit_session=146&commit=true` -- подтверждает сеанс редактирования 146 лекарства 3 и вносит в БД все изменения.
`/drug/edit?id=3&edit_session=146&commit=false` -- отменяет все изменения, сделанные в сеансе редактирования 146

"Сеанс редактирования" позволяет откладывать публикацию изменений. Изменения, сделанные в сеансе, видны клиенту, владеющему сеансом, но до определённого момента не видны другим клиентам. Изменения, сделанные в сеансе редактирования, становятся видны другим клиентам после подтверждения сеанса, или полностью отменяются после указания их отменить.

Если в запросе не указан аргумент `edit_session`, но указан аргумент `commit` со значением `true`, то изменения, которые делает запрос, вносятся и подтверждаются немедленно.

Если в запросе не указан аргумент `edit_session`, и не указан аргумент `commit` (или указан со значением `false`) то открывается новый сеанс редактирования, и изменения, требуемые запросом, делаются в нём.

Если в запросе указан аргумент `edit_session`, то измения, требуемые запросом, делаются в этом сеансе редактирования. Если дополнительно указан аргумент `commit` со значением `true`, то изменения вносятся и сеанс закрывается. Если указан аргумент `commit` со значением `false`, то все изменения сеанса отменяются.

Подтверждение сеанса редактирования должно адекватно реагировать на наличие подтверждённых конкурентных изменений, сделанных в других сеансах. При обнаружении таковых, запрос, делающий подтверждение, должен ,как минимум, получать ответ HTTP 409. Если приложение может дать какие-то подробности о конфликте, то они должны быть в тексте ответа.

**Структура ответа**

В ответе посылается идентификатор сеанса редактирования, если он открыт, и значение редактируемых атрибутов, актуальное для данного сеанса редактирования. Владелец сеанса должен видеть свои изменения, и получать их в ответе, даже если они ещё не подтверждены.

Запрос: `/drug/edit?id=3&edit_session=146&active_ingredient=сахар`

```
[
{
  "id": "3", // идентификатор лекарства
  "edit_session": 146,
  "trade_name": "фуфломицин", // патентованное название
  "international_name": "placebo", // международное непатентованное название
  "active_ingredient": "сахар", // Активный ингредиент

},
]
```

Запрос: `/drug/edit?id=3&edit_session=146&commit=false` (отменяет изменения сеанса, получает актуальные значения, идентификатора сеанса нет)

```
[
{
  "id": "3", // идентификатор лекарства
  "trade_name": "фуфломицин", // патентованное название
  "international_name": "placebo", // международное непатентованное название
  "active_ingredient": "aqua pura", // Активный ингредиент
},
]
```



